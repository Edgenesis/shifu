trigger:
  branches:
    include:
    - main
    - release*
  paths:
    exclude:
    - docs
    - examples
    - img
    - README*
    - LICENSE
    - .devcontainer
    - .github
    - CHANGELOG
  tags:
    include:
    - '*'
pr:
  branches:
    include:
    - main
    - release*
  paths:
    exclude:
    - docs
    - examples
    - img
    - README*
    - LICENSE
    - .devcontainer
    - .github
    - CHANGELOG

variables:
  - name: tag
    value: ''

pool:
   vmImage: 'ubuntu-latest'

stages:
- stage: go_test_and_kind_e2e_test
  jobs:
  - job: go_build_and_test
    steps:
      - task: GoTool@0
        inputs:
          version: '1.20.2'
      - task: Go@0
        displayName: "go get"
        inputs:
          command: 'get'
          arguments: '-d'
          workingDirectory: '$(System.DefaultWorkingDirectory)/pkg/deviceshifu/deviceshifuhttp'
      - script: |
          sudo apt-get install libpcap-dev
        displayName: "Install pcap"
      - script: |
          make build
          make test
        displayName: "Go build and test"

  - job: go_build_and_test_windows
    pool:
      vmImage: 'windows-latest'
    steps:
      - task: GoTool@0
        inputs:
          version: '1.20.2'
      - task: Go@0
        displayName: "go get"
        inputs:
          command: 'get'
          arguments: '-d'
          workingDirectory: '$(System.DefaultWorkingDirectory)/pkg/deviceshifu/deviceshifuhttp'
      - task: Go@0
        displayName: "go build http to powershell stub"
        inputs:
          command: 'build'
          workingDirectory: '$(System.DefaultWorkingDirectory)/cmd/httpstub/powershellstub'
          arguments: '-a -o $(System.DefaultWorkingDirectory)/output/http2powershell.exe'
      - script: |
          START "" $(System.DefaultWorkingDirectory)/output/http2powershell.exe
          curl.exe -d "ls" "http://localhost:11112/issue_cmd"
        displayName: test powershell stub

  - job: kind_e2e_test_http
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-shifu-controller
        displayName: build edgehub/shifu-controller
      - script: |
          make buildx-build-image-deviceshifu-http-http
        displayName: build edgehub/deviceshifu-http-http
      - script: |
          make buildx-build-image-mockdevice-thermometer
        displayName: build edgehub/mockdevice-thermometer
      - script: |
          make buildx-build-image-mockdevice-robot-arm
        displayName: build edgehub/mockdevice-robot-arm
      - script: |
          make buildx-build-image-mockdevice-plate-reader
        displayName: build edgehub/mockdevice-plate-reader
      - script: |
          make buildx-build-image-mockdevice-agv
        displayName: build edgehub/mockdevice-agv
      - script: |
          make buildx-build-image-mockdevice-plc
        displayName: build edgehub/mockdevice-plc
      - script: |
          set -e
          kind --version
          kind delete cluster && kind create cluster
          kind load docker-image edgehub/shifu-controller:$(tag)
          kind load docker-image edgehub/mockdevice-thermometer:$(tag)
          kind load docker-image edgehub/mockdevice-plate-reader:$(tag)
          kind load docker-image edgehub/mockdevice-robot-arm:$(tag)
          kind load docker-image edgehub/mockdevice-agv:$(tag)
          kind load docker-image edgehub/mockdevice-plc:$(tag)
          kind load docker-image edgehub/deviceshifu-http-http:$(tag)   

          kubectl version
          kubectl apply -f $(System.DefaultWorkingDirectory)/pkg/k8s/crd/install/shifu_install.yml
          kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        displayName: "setup Kind cluster and install Shifu"
      - script: |
          set -e
          kubectl run nginx --image=nginx -n deviceshifu
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-plc
          kubectl wait --for=condition=Available deploy/plc -n devices --timeout=150s
          kubectl wait --for=condition=Available deploy/deviceshifu-plc-deployment -n deviceshifu --timeout=150s
          sleep 5
          kubectl wait --for condition=Ready pod/nginx -n deviceshifu --timeout=150s
          kubectl exec -it -n deviceshifu nginx -- curl deviceshifu-plc/getcontent?rootsssaddress=Q;echo
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-plc
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-agv
          kubectl wait --for=condition=Available deploy/deviceshifu-agv-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=condition=Available deploy/agv -n devices --timeout=150s
          sleep 5
          kubectl exec -it -n deviceshifu nginx -- curl http://deviceshifu-agv/get_position
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-agv
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-plate-reader
          kubectl wait --for=condition=Available deploy/deviceshifu-plate-reader-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=condition=Available deploy/plate-reader -n devices --timeout=150s
          sleep 5
          kubectl exec -it -n deviceshifu nginx -- curl http://deviceshifu-plate-reader/get_measurement
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-plate-reader
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-robot-arm
          kubectl wait --for=condition=Available deploy/deviceshifu-robotarm-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=condition=Available deploy/robotarm -n devices --timeout=150s
          sleep 5    
          kubectl exec -it -n deviceshifu nginx -- curl http://deviceshifu-robotarm/get_coordinate
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-robot-arm
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-thermometer
          kubectl wait --for=condition=Available deploy/deviceshifu-thermometer-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=condition=Available deploy/thermometer -n devices --timeout=150s
          sleep 5    
          kubectl exec -it -n deviceshifu nginx -- curl http://deviceshifu-thermometer/read_value
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-thermometer
        displayName: "Shifu demo device HTTP E2E test"
    
  - job: kind_e2e_test_opcua
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-shifu-controller
        displayName: build edgehub/shifu-controller
      - script: |
          make buildx-build-image-deviceshifu-http-opcua
        displayName: build deviceshifu-http-opcua
      - script: |
          make buildx-build-image-mockdevice-opcua
        displayName: build mockdevice-opcua
      - script: |
          set -e
          kind --version
          kind delete cluster && kind create cluster
          kind load docker-image edgehub/shifu-controller:$(tag)
          kind load docker-image edgehub/deviceshifu-http-opcua:$(tag)
          kind load docker-image edgehub/mockdevice-opcua:$(tag)

          kubectl version
          kubectl apply -f $(System.DefaultWorkingDirectory)/pkg/k8s/crd/install/shifu_install.yml
          kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        displayName: "setup Kind cluster and install Shifu"
      - script: |
          set -e 
          kubectl run nginx --image=nginx -n deviceshifu
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-opcua/mock-device
          kubectl wait --for=condition=Available deploy/mockdevice-opcua -n devices --timeout=150s
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-opcua
          kubectl wait --for=condition=Available deploy/deviceshifu-opcua-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=jsonpath='{status.edgedevicephase}'=Running edgedevice/edgedevice-opcua -n devices --timeout=150s
          kubectl wait --for=condition=Ready pod/nginx -n deviceshifu --timeout=150s
          bash $(System.DefaultWorkingDirectory)/examples/deviceshifu/mockdevice/opcua/checkout.sh
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-opcua
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-opcua/mock-device
        displayName: "Shifu demo device OPCUA E2E test"

  - job: kind_e2e_test_socket
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-shifu-controller
        displayName: build edgehub/shifu-controller
      - script: |
          make buildx-build-image-deviceshifu-http-socket
        displayName: build edgehub/deviceshifu-http-socket
      - script: |
          make buildx-build-image-mockdevice-socket
        displayName: build mockdevice-socket
      - script: |
          set -e
          kind --version
          kind delete cluster && kind create cluster
          kind load docker-image edgehub/shifu-controller:$(tag)
          kind load docker-image edgehub/deviceshifu-http-socket:$(tag)
          kind load docker-image edgehub/mockdevice-socket:$(tag)

          kubectl version
          kubectl apply -f $(System.DefaultWorkingDirectory)/pkg/k8s/crd/install/shifu_install.yml
          kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        displayName: "setup Kind cluster and install Shifu"
      - script: |
          set -e 
          kubectl run nginx --image=nginx -n deviceshifu
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-socket/mock-device
          kubectl wait --for=condition=Available deploy/mockdevice-socket -n devices --timeout=150s
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-socket
          kubectl wait --for=condition=Available deploy/deviceshifu-socket-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=jsonpath='{status.edgedevicephase}'=Running edgedevice/edgedevice-socket -n devices --timeout=150s
          kubectl wait --for=condition=Ready pod/nginx -n deviceshifu --timeout=150s
          bash $(System.DefaultWorkingDirectory)/examples/deviceshifu/mockdevice/socket/checkout.sh
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-socket
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-socket/mock-device
        displayName: "Shifu demo device Socket E2E test" 

  - job: kind_e2e_test_mqtt
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-shifu-controller
        displayName: build edgehub/shifu-controller
      - script: |
          make buildx-build-image-deviceshifu-http-mqtt
        displayName: build edgehub/deviceshifu-http-mqtt
      - script: |
          set -e
          kind --version
          kind delete cluster && kind create cluster
          kind load docker-image edgehub/shifu-controller:$(tag)  
          kind load docker-image edgehub/deviceshifu-http-mqtt:$(tag)

          kubectl version
          kubectl apply -f $(System.DefaultWorkingDirectory)/pkg/k8s/crd/install/shifu_install.yml
          kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        displayName: "setup Kind cluster and install Shifu"
      - script: |
          set -e 
          kubectl run nginx --image=nginx -n deviceshifu
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/demo_device/edgedevice-mqtt
          kubectl wait --for=condition=Available deploy/mosquitto -n devices --timeout=150s
          kubectl wait --for=condition=Available deploy/deviceshifu-mqtt-deployment -n deviceshifu --timeout=150s
          kubectl run mosquitto -n devices --image=eclipse-mosquitto:2.0.14
          kubectl wait --for=condition=Ready pod/mosquitto -n devices --timeout=150s
          kubectl wait --for=condition=Ready pod/nginx -n deviceshifu --timeout=150s
          bash $(System.DefaultWorkingDirectory)/examples/deviceshifu/mockdevice/mqtt/checkoutput.sh
          kubectl delete -f examples/deviceshifu/demo_device/edgedevice-mqtt
          kubectl delete po mosquitto -n devices
        displayName: "Shifu demo device MQTT E2E test"

  - job: kind_e2e_test_customized
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-shifu-controller
        displayName: build edgehub/shifu-controller
      - script: |
          docker buildx build --platform=linux/amd64 \
          -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector/Dockerfile \
          --build-arg PROJECT_ROOT="$(System.DefaultWorkingDirectory)" $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector \
          -t edgehub/humidity-detector:$(tag) --load
        displayName: build edgehub/humidity-detector
      - script: |
          docker buildx build --platform=linux/amd64 \
          -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector/sample_deviceshifu_dockerfiles/Dockerfile.deviceshifuHTTP-Python \
          --build-arg PROJECT_ROOT="$(System.DefaultWorkingDirectory)" $(System.DefaultWorkingDirectory) \
          -t edgehub/deviceshifu-http-http-python:$(tag) --load
        displayName: build edgehub/deviceshifu-http-http-python
      - script: |
          docker buildx build --platform=linux/amd64 \
          -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector/mockserver/Dockerfile \
          --build-arg PROJECT_ROOT="$(System.DefaultWorkingDirectory)" $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector/mockserver \
          -t edgehub/mockserver:$(tag) --load
        displayName: build edgehub/mockserver
      - script: |
          set -e
          kind --version
          kind delete cluster && kind create cluster
          kind load docker-image edgehub/shifu-controller:$(tag)
          kind load docker-image edgehub/humidity-detector:$(tag)  
          kind load docker-image edgehub/deviceshifu-http-http-python:$(tag)
          kind load docker-image edgehub/mockserver:$(tag)

          kubectl version
          kubectl apply -f $(System.DefaultWorkingDirectory)/pkg/k8s/crd/install/shifu_install.yml
          kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        displayName: "setup Kind cluster and install Shifu"
      - script: |
          set -e 
          kubectl run nginx --image=nginx -n deviceshifu
          kubectl apply -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector/configuration
          kubectl wait --for=condition=Available deploy/humidity-detector -n devices --timeout=150s
          kubectl wait --for=condition=Available deploy/deviceshifu-humidity-detector-deployment -n deviceshifu --timeout=150s
          kubectl wait --for=condition=Available deploy/mockserver -n devices --timeout=150s
          kubectl wait --for=condition=Ready pod/nginx -n deviceshifu --timeout=150s
          cd $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector && bash checkout.sh && cd -
          kubectl delete -f $(System.DefaultWorkingDirectory)/examples/deviceshifu/customized/humidity_detector/configuration
        displayName: "Shifu demo humidity_detector deviceshifu E2E test"

  - job: build_test_plc4x
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-deviceshifu-http-plc4x
        displayName: build edgehub/deviceshifu-http-plc4x

  - job: docker_e2e_test_telemetryservice
    steps:
      - script: |
          tag=`cat version.txt` && echo "##vso[task.setvariable variable=tag]$tag"
        displayName: Set the tag name as an environment variable
      - script: |
          make buildx-build-image-telemetry-service
          docker run -itd --network host -e SERVER_LISTEN_PORT=:17772 edgehub/telemetryservice:$(tag)
        displayName: build edgehub/telemetryService
      - script: |
          docker buildx build --platform=linux/amd64 \
            -f $(System.DefaultWorkingDirectory)/examples/telemetryservice/mockclient/Dockerfile.mockclient \
            --build-arg PROJECT_ROOT="$(System.DefaultWorkingDirectory)" $(System.DefaultWorkingDirectory) \
            -t edgehub/mockclient:$(tag) --load
          docker run -itd --network host -e TARGET_SERVER_ADDRESS=:17772 \
            -e TARGET_MQTT_SERVER_ADDRESS=localhost:1883 \
            -e TARGET_TDENGINE_SERVER_ADDRESS=localhost:6041 \
            -e TARGET_MYSQL_SERVER_ADDRESS=localhost:3306 \
            -e TARGET_SQLSERVER_SERVER_ADDRESS=localhost:1433 \
            --name mockclient edgehub/mockclient:$(tag)
        displayName: build mockClient
      - script: |
          docker buildx build --platform=linux/amd64 \
            -f $(System.DefaultWorkingDirectory)/examples/telemetryservice/mockserver/Dockerfile.mockserver \
            --build-arg PROJECT_ROOT="$(System.DefaultWorkingDirectory)" $(System.DefaultWorkingDirectory) \
            -t edgehub/mockserver:$(tag) --load
        displayName: build and run mockServer
      - script: | 
          docker run -itd --network host --name nginx nginx:1.21  
        displayName: docker run nginx
      - script: |
          set -e
          docker run -itd --network host --name mosquitto eclipse-mosquitto:2.0.15
          docker run -itd --network host --name mockserver edgehub/mockserver:$(tag)
          bash $(System.DefaultWorkingDirectory)/examples/telemetryservice/mqtt/checkoutput.sh
        displayName: e2e_test_mqtt and checkoutput
      - script: |
          set -e
          docker run -itd --network host --name tdengine \
            -v $(System.DefaultWorkingDirectory)/examples/telemetryservice/tdengine/init.sql:/root/init.sql \
            tdengine/tdengine:3.0.1.4
          bash $(System.DefaultWorkingDirectory)/examples/telemetryservice/tdengine/checkoutput.sh
        displayName: docker run tdengine and checkoutput
      - script: |
          set -e
          docker run -itd --network host --name mysql -e MYSQL_ALLOW_EMPTY_PASSWORD=yes mysql:8.1.0
          bash $(System.DefaultWorkingDirectory)/examples/telemetryservice/mysql/checkoutput.sh
        displayName: docker run mysql and checkoutput
      - script: |
          set -e
          docker run -itd --network host --name sqlserver -e ACCEPT_EULA=Y -e SA_PASSWORD=Some_Strong_Password \
            mcr.microsoft.com/mssql/server:2022-latest
          bash $(System.DefaultWorkingDirectory)/examples/telemetryservice/sqlserver/checkoutput.sh
        displayName: docker run sqlserver and checkoutput


- stage: docker_build_muiltiarch_and_push
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), not(startsWith(variables['Build.SourceBranchName'],'release')))
  variables:
  - name: release_tag
    ${{ if eq(variables['Build.SourceBranchName'], 'main')}}:
      value: 'nightly'
    ${{ else }}:
      value: $[replace(variables['build.sourcebranch'], 'refs/tags/', '')]
  jobs:
  - job: docker_push_deviceshifu_http_http
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-deviceshifu-http-http
        displayName: build edgehub/deviceshifu-http-http

  - job: docker_push_deviceshifu_http_socket
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-deviceshifu-http-socket
        displayName: build edgehub/deviceshifu-http-socket

  - job: docker_push_deviceshifu_http_mqtt
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-deviceshifu-http-mqtt
        displayName: build edgehub/deviceshifu-http-mqtt

  - job: docker_push_deviceshifu_http_opcua
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-deviceshifu-http-opcua
        displayName: build deviceshifu-http-opcua

  - job: docker_push_deviceshifu_http_plc4x
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-deviceshifu-http-plc4x
        displayName: build deviceshifu-http-plc4x

  - job: docker_push_deviceshifu_tcp_tcp
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-deviceshifu-tcp-tcp
        displayName: build deviceshifu-tcp-tcp

  - job: docker_push_shifu_controller
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-shifu-controller
        displayName: build edgehub/shifu-controller

  - job: docker_push_mockdevice_thermometer
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-thermometer
        displayName: build edgehub/mockdevice-thermometer

  - job: docker_push_mockdevice_robot_arm
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-robot-arm
        displayName: build edgehub/mockdevice-robot-arm

  - job: docker_push_mockdevice_plate_reader
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-plate-reader
        displayName: build edgehub/mockdevice-plate-reader

  - job: docker_push_mockdevice_agv
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-agv
        displayName: build edgehub/mockdevice-agv

  - job: docker_push_mockdevice_plc
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-plc
        displayName: build edgehub/mockdevice-plc

  - job: docker_push_mockdevice_socket
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-socket
        displayName: build edgehub/mockdevice-socket

  - job: docker_push_mockdevice_opcua
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-mockdevice-opcua
        displayName: build edgehub/mockdevice-opcua

  - job: docker_push_telemetry_service
    steps: 
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: dockerhub-connection
      - script: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
        displayName: configure multi-arch and buildx
      - script: |
          make buildx-push-image-telemetry-service
        displayName: push edgehub/telemetryservice

- stage: docker_build_shifu_demo_push
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), contains(variables['Build.SourceBranch'],'refs/tags'), not(contains(variables['Build.SourceBranchName'],'rc')))
  jobs:
  - job: docker_push_shifu_demo
    steps:
    - script: |
        set -e
        bash test/scripts/deviceshifu-demo-aio.sh build_demo amd64
        bash test/scripts/deviceshifu-demo-aio.sh build_demo arm64
        ls -al
      displayName: 'Run the build script'
    - script: |
        set -e
        mkdir testdir && tar -xvf shifu_demo_aio_linux_amd64.tar -C testdir && cd testdir
        chmod +x test/scripts/deviceshifu-demo-aio.sh && sudo ./test/scripts/deviceshifu-demo-aio.sh run_demo
      displayName: 'test run_demo'
    - script: |
        set -e
        sudo kubectl run nginx --image=nginx:1.21 -n deviceshifu
        sudo kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        sudo kubectl wait --for=condition=Available deploy/deviceshifu-agv-deployment -n deviceshifu --timeout=150s
        sudo kubectl wait --for=condition=Available deploy/agv -n devices --timeout=150s
        sudo kubectl wait --for=condition=Ready pod/nginx -n deviceshifu --timeout=150s
        sudo kubectl exec -it -n deviceshifu nginx -- curl http://deviceshifu-agv/get_position
      displayName: 'test run_demo result'
    - task: CopyFilesOverSSH@0
      condition: succeeded()
      inputs:
        sshEndpoint: 'shifurun-ssh'
        contents: |
          shifu_demo_aio_linux_amd64.tar
          shifu_demo_aio_linux_arm64.tar
        targetFolder: '/home/ubuntu/demo-files'
        readyTimeout: '20000'
        failOnEmptySource: true
    - task: SSH@0
      condition: succeeded()
      inputs:
        sshEndpoint: 'shifurun-ssh'
        runOptions: 'inline'
        inline: 'sudo cp -R /home/ubuntu/demo-files/* /var/www/demo-site/demo-content'
        readyTimeout: '20000'

    - task: CopyFilesOverSSH@0
      condition: succeeded()
      displayName: push demo file to shifu.dev
      inputs:
        sshEndpoint: 'shifu.dev'
        contents: |
          shifu_demo_aio_linux_amd64.tar
          shifu_demo_aio_linux_arm64.tar
        targetFolder: '/home/ubuntu/demo-files'
        readyTimeout: '20000'
        failOnEmptySource: true
    - task: SSH@0
      condition: succeeded()
      inputs:
        sshEndpoint: 'shifu.dev'
        runOptions: 'inline'
        inline: 'sudo cp -R /home/ubuntu/demo-files/* /var/www/demo-site/demo-content'
        readyTimeout: '20000'

  - job: docker_push_shifu_demo_mac
    pool: 
      vmImage: 'macOS-12'
    steps:
    - script: |
        brew --version
        brew update
        brew --version
        dockerInstallationScriptName='docker.rb'
        dockerInstallationScriptUrl="https://raw.githubusercontent.com/Homebrew/homebrew-cask/fe866ec0765de141599745f03e215452db7f511b/Casks/$dockerInstallationScriptName"
        # dockerInstallationScriptUrl="https://raw.githubusercontent.com/Homebrew/homebrew-cask/master/Casks/$dockerInstallationScriptName"
        curl -L  $dockerInstallationScriptUrl > $dockerInstallationScriptName && brew install --cask $dockerInstallationScriptName
        echo 'Installing Docker Desktop for Mac ...'
        start=$SECONDS
        sudo /Applications/Docker.app/Contents/MacOS/Docker --unattended --install-privileged-components
        open -a /Applications/Docker.app --args --unattended --accept-license
        end=$SECONDS
        duration=$(( end - start ))
        echo "Docker Desktop for Mac has been installed in $duration seconds"
        echo 'Starting Docker service ...'
        start=$SECONDS
        retries=0
        maxRetries=100
        sudo bash -c `
        set -x
        command -v docker || echo 'test docker command 1: not found'
        i=0
        while ! /Applications/Docker.app/Contents/Resources/bin/docker system info &>/dev/null; do
        (( i++ == 0 )) && printf %s '-- Waiting for Docker to finish starting up...' || printf '.'
        command -v docker || echo 'test docker command loop: not found'
        sleep 5
        if [ $i -gt 180 ];then sudo /Applications/Docker.app/Contents/MacOS/com.docker.diagnose check;uname -a;system_profiler SPHardwareDataType;echo "::error::-- Wait docker start $i s too long, exit"; exit 1; fi
        done
        echo "::notice::-- Docker is ready.Wait time is $i s"
        uname -a || true
        system_profiler SPHardwareDataType || true
        `
        end=$SECONDS
        duration=$(( end - start ))
        echo "Docker service has started after $duration seconds"
        docker --version
        docker-compose --version
      displayName: Install and start Docker
    - script: |
        set -e
        bash ./test/scripts/deviceshifu-demo-aio.sh build_demo amd64
        bash ./test/scripts/deviceshifu-demo-aio.sh build_demo arm64
        ls -al
      displayName: 'Run the build script'
    - script: |
        set -e
        mkdir testdir && tar -xvf shifu_demo_aio_darwin_amd64.tar -C testdir && cd testdir
        chmod +x ./test/scripts/deviceshifu-demo-aio.sh && sudo ./test/scripts/deviceshifu-demo-aio.sh run_demo
      displayName: 'test run_demo'
    - script: |
        set -e
        sudo kubectl wait --for=condition=Available deploy/shifu-crd-controller-manager -n shifu-crd-system --timeout=150s
        sudo kubectl wait --for=condition=Available deploy/deviceshifu-agv-deployment -n deviceshifu --timeout=150s
        sudo kubectl wait --for=condition=Available deploy/agv -n devices --timeout=150s
        sudo kubectl run nginx --image=nginx:1.21 -n deviceshifu
        sudo kubectl wait --for=condition=Ready pod/nginx -n deviceshifu --timeout=150s
        sudo kubectl exec -it -n deviceshifu nginx -- curl http://deviceshifu-agv/get_position
      displayName: 'test run_demo result'
    - task: CopyFilesOverSSH@0
      condition: succeeded()
      inputs:
        sshEndpoint: 'shifurun-ssh'
        contents: |
          shifu_demo_aio_darwin_amd64.tar
          shifu_demo_aio_darwin_arm64.tar
        targetFolder: '/home/ubuntu/demo-files'
        readyTimeout: '20000'
        failOnEmptySource: true
    - task: SSH@0
      condition: succeeded()
      inputs:
        sshEndpoint: 'shifurun-ssh'
        runOptions: 'inline'
        inline: 'sudo cp -R /home/ubuntu/demo-files/* /var/www/demo-site/demo-content'
        readyTimeout: '20000'
  
    - task: CopyFilesOverSSH@0
      condition: succeeded()
      displayName: push demo file to shifu.dev mac
      inputs:
        sshEndpoint: 'shifu.dev'
        contents: |
          shifu_demo_aio_darwin_amd64.tar
          shifu_demo_aio_darwin_arm64.tar
        targetFolder: '/home/ubuntu/demo-files'
        readyTimeout: '20000'
        failOnEmptySource: true
    - task: SSH@0
      condition: succeeded()
      inputs:
        sshEndpoint: 'shifu.dev'
        runOptions: 'inline'
        inline: 'sudo cp -R /home/ubuntu/demo-files/* /var/www/demo-site/demo-content'
        readyTimeout: '20000'
