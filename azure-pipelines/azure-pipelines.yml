trigger:
  branches:
    include:
      - main
      - release*
  paths:
    exclude:
      - docs
      - examples
      - img
      - README*
      - LICENSE
      - .devcontainer
      - .github
      - CHANGELOG
  tags:
    include:
      - "*"
pr:
  branches:
    include:
      - main
      - release*
  paths:
    exclude:
      - docs
      - examples
      - img
      - README*
      - LICENSE
      - .devcontainer
      - .github
      - CHANGELOG

variables:
  - name: tag
    value: ""
  - name: goVersion
    value: "1.24.2"

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: macos_docker_smoke
    displayName: macOS Docker smoke
    condition: contains(variables['Build.SourceBranch'], 'macos-docker-smoke')
    jobs:
      - job: macos_docker_smoke
        displayName: macOS Docker smoke
        pool:
          vmImage: "macOS-latest"
        steps:
          - script: |
              set -euo pipefail
              DOCKER_CLI="/Applications/Docker.app/Contents/Resources/bin/docker"
              brew --version
              brew update
              brew --version
              brew install --cask --no-quarantine docker
              echo 'Installing Docker Desktop for Mac ...'
              start=$SECONDS
              sudo /Applications/Docker.app/Contents/MacOS/Docker --unattended --install-privileged-components
              open -a /Applications/Docker.app --args --unattended --accept-license
              i=0
              while ! "$DOCKER_CLI" system info &>/dev/null; do
                if [ $i -eq 0 ]; then
                  printf '%s' '-- Waiting for Docker to finish starting up...'
                else
                  printf '.'
                fi
                sleep 5
                i=$((i + 1))
                if [ $i -gt 180 ]; then
                  echo '\n::error::Docker did not start within expected time';
                  sudo /Applications/Docker.app/Contents/MacOS/com.docker.diagnose check || true
                  exit 1
                fi
              done
              end=$SECONDS
              duration=$(( end - start ))
              printf '\nDocker Desktop started after %s seconds\n' "$duration"
              "$DOCKER_CLI" --version
              "$DOCKER_CLI" run --rm hello-world
            displayName: Install Docker Desktop and run hello-world