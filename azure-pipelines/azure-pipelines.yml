trigger:
  branches:
    include:
      - main
      - release*
  paths:
    exclude:
      - docs
      - examples
      - img
      - README*
      - LICENSE
      - .devcontainer
      - .github
      - CHANGELOG
  tags:
    include:
      - "*"
pr:
  branches:
    include:
      - main
      - release*
  paths:
    exclude:
      - docs
      - examples
      - img
      - README*
      - LICENSE
      - .devcontainer
      - .github
      - CHANGELOG

variables:
  - name: tag
    value: ""
  - name: goVersion
    value: "1.24.2"

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: macos_docker_smoke
    displayName: macOS Docker smoke
    jobs:
      - job: macos_docker_smoke
        displayName: macOS Docker smoke
        pool:
          vmImage: "macOS-latest"
        steps:
          - script: |
              set -euo pipefail
              echo 'Installing Docker Desktop...'
              brew install --cask --no-quarantine docker-desktop
              echo 'Installing Docker components...'
              sudo /Applications/Docker.app/Contents/MacOS/install --accept-license
              echo 'Starting Docker Desktop...'
              open -a /Applications/Docker.app --args --unattended --accept-license
              echo 'Waiting for Docker socket...'
              i=0
              while [ ! -S /var/run/docker.sock ] && ! docker version &>/dev/null; do
                if [ $i -eq 0 ]; then
                  printf '%s' '-- Waiting for Docker socket...'
                else
                  printf '.'
                fi
                sleep 5
                i=$((i + 1))
                if [ $i -gt 60 ]; then
                  echo '\n::error::Docker did not start within 5 minutes'
                  ls -la /var/run/docker.sock || true
                  docker version || true
                  ps aux | grep -i docker || true
                  break
                fi
              done
              echo '\nTesting Docker...'
              docker --version || /usr/local/bin/docker --version || /Applications/Docker.app/Contents/Resources/bin/docker --version
              docker run --rm hello-world || echo "Docker run failed, but installation completed"
            displayName: Install Docker Desktop and run hello-world