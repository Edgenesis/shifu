trigger:
  branches:
    include:
      - main
      - release*
  paths:
    exclude:
      - docs
      - examples
      - img
      - README*
      - LICENSE
      - .devcontainer
      - .github
      - CHANGELOG
  tags:
    include:
      - "*"
pr:
  branches:
    include:
      - main
      - release*
  paths:
    exclude:
      - docs
      - examples
      - img
      - README*
      - LICENSE
      - .devcontainer
      - .github
      - CHANGELOG

variables:
  - name: tag
    value: ""
  - name: goVersion
    value: "1.24.2"

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: macos_docker_smoke
    displayName: macOS Docker smoke
    jobs:
      - job: macos_docker_smoke
        displayName: macOS Docker smoke
        pool:
          vmImage: "macOS-latest"
        steps:
          - script: |
              set -euo pipefail
              DOCKER_CLI="/Applications/Docker.app/Contents/Resources/bin/docker"
              echo 'Installing Docker Desktop...'
              brew install --cask --no-quarantine docker-desktop
              echo 'Installing Docker components...'
              sudo /Applications/Docker.app/Contents/MacOS/install --accept-license
              echo 'Starting Docker daemon...'
              sudo /Applications/Docker.app/Contents/MacOS/com.docker.backend &
              echo 'Waiting for Docker daemon to be ready...'
              i=0
              while ! "$DOCKER_CLI" version &>/dev/null; do
                if [ $i -eq 0 ]; then
                  printf '%s' '-- Waiting for Docker daemon...'
                else
                  printf '.'
                fi
                sleep 5
                i=$((i + 1))
                if [ $i -gt 120 ]; then
                  echo '\n::error::Docker daemon did not start within expected time';
                  ps aux | grep docker || true
                  exit 1
                fi
              done
              printf '\nDocker daemon is ready\n'
              "$DOCKER_CLI" --version
              "$DOCKER_CLI" run --rm hello-world
            displayName: Install Docker Desktop and run hello-world