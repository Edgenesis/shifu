# Telemetry Service SQL Endpoint Design

## Introduction
Telemetry Service is a standalone service that takes telemetry data collected by `deviceShifu` and fan-out it to designated endpoints for future process.

## Design-Goal
- Let telemetry service support pushing telemetries to SQL endpoints.

## Design Non-Goal
- Let telemetry service support any random endpoints
- Let telemetry service serve as SQL service.

## Design Details
We will predefine the schema for the database, since the uncertainty of schema and data format will make the feature hard to use and debug.

The predefined schema looks like:
```SQL
CREATE TABLE ${DbTableName}
(
    TelemetryID INT IDENTITY(1,1) PRIMARY KEY,
    DeviceName VARCHAR(255),
    TelemetryData TEXT,
    TelemetryTimeStamp DATETIME
);
```

`TelemetryID`  is generated by the telemetry service, `DeviceName` is get from  `EdgeDeviceSpec`'s SKU', `TelemetryData` is the raw data collected from device and `TelemetryTimeStamp` is the time of data collected.

We will add `EdgeDeviceSpec` into our `TelemetryRequest` in order to get device related info to our database:

```go
type TelemetryRequest struct {
+	Spec                 EdgeDeviceSpec        `json:spec,omitempty`
	RawData              []byte                `json:"rawData,omitempty"`
	MQTTSetting          *MQTTSetting          `json:"mqttSetting,omitempty"`
	SQLConnectionSetting *SQLConnectionSetting `json:"sqlConnectionSetting,omitempty"`
	MinIOSetting         *MinIOSetting         `json:"minIOSetting,omitempty"`
}
```

Thanks to our good design for TDEngine, we can simply add a new `dbType` in our `SQLConnection` field to establish the connection to SQL Server.

```go
const (
    DBTypeTDengine DBType = "TDengine"
+   DBTypeSQLServer DBType = "SQLServer"
+   DBTypeMySQL DBType = "MySQL"
)

```

We then create a new package called `SQLServer` and `MySQL` alone with `TDengine`, and similar to `TDengine`, we can implement the functions of `ConnectDB` and `SendToDB`. However, the sql statement for `SQLServer` and `MySQL` should be:
```go

func sendToSQLServer(rawData []byte, sqlcs *v1alpha1.SQLConnectionSetting) err {
	// Send rawData to TDengine
    // sample code:
    qlURL := constructTDengineUri(sqlcs)
    db, err := sql.Open("SQLServer", taosUri)
    if err != nil {
        klog.Error("failed to connect SQLServer, err:", err)
        return err
    }
    defer db.Close()
    ...

}

func insertIntoDB() {
    ...
    // DeviceId is retrieved from edgeDeviceSpec, primary id is generated by database
    result, err := db.DB.Exec(fmt.Sprintf("Insert Into %s (DeviceName,TelemetryData,TelemetryTimeStamp) Values('%s','%s','%s')", *db.Settings.DBTable, deviceName, string(rawData), time.Now().Format("2006-01-02 15:04:05")))
    ...
}
```



