# Cert-Manager Integration for Metrics TLS

This directory contains cert-manager resources for generating TLS certificates for the controller's metrics endpoint.

## Why Use Cert-Manager?

By default, the controller uses self-signed certificates generated by controller-runtime. While this works for development, it has a critical limitation in production:

**Problem**: The self-signed certificate only includes `localhost` and `127.0.0.1` as Subject Alternative Names (SANs). When Prometheus scrapes metrics via the Kubernetes service DNS name (e.g., `shifu-crd-controller-manager-metrics-service.shifu-crd-system.svc`), it will fail with an x509 certificate error:

```
x509: certificate is valid for localhost, 127.0.0.1,
not shifu-crd-controller-manager-metrics-service.shifu-crd-system.svc
```

**Solution**: Cert-manager generates certificates with the correct DNS names in SANs, allowing secure metrics scraping.

## Prerequisites

Install cert-manager in your cluster:

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.0/cert-manager.yaml
```

## Enabling Cert-Manager Integration

1. **Edit `config/default/kustomization.yaml`** and uncomment the following sections:

   ```yaml
   # Line 25 - Add cert-manager resources
   resources:
   - ../certmanager  # Uncomment this line

   # Lines 47-49 - Apply certificate patch
   patches:
   - path: cert_metrics_manager_patch.yaml  # Uncomment this block
     target:
       kind: Deployment

   # Lines 59-118 - Enable kustomize replacements for DNS injection
   replacements:  # Uncomment the entire replacements section
   - source:
       kind: Service
       ...
   ```

2. **Regenerate manifests**:

   ```bash
   cd pkg/k8s/crd
   make generate-controller-yaml generate-install-yaml
   ```

3. **Deploy**:

   ```bash
   kubectl apply -f install/shifu_install.yml
   ```

4. **Verify certificate creation**:

   ```bash
   kubectl get certificate -n shifu-crd-system
   kubectl get secret metrics-server-cert -n shifu-crd-system
   kubectl describe certificate shifu-crd-metrics-certs -n shifu-crd-system
   ```

## What Gets Created

- **Issuer**: `shifu-crd-selfsigned-issuer` - A self-signed certificate issuer
- **Certificate**: `shifu-crd-metrics-certs` - Certificate with proper DNS SANs:
  - `shifu-crd-controller-manager-metrics-service.shifu-crd-system.svc`
  - `shifu-crd-controller-manager-metrics-service.shifu-crd-system.svc.cluster.local`
- **Secret**: `metrics-server-cert` - Contains `ca.crt`, `tls.crt`, and `tls.key`

The certificate is automatically mounted to `/tmp/k8s-metrics-server/metrics-certs` in the controller pod.

## Disabling (Default Behavior)

To disable cert-manager integration and use controller-runtime's self-signed certificates:

1. Comment out the sections mentioned above in `config/default/kustomization.yaml`
2. Regenerate manifests: `make generate-controller-yaml generate-install-yaml`

**Note**: This is the default configuration. The controller will still work but Prometheus scraping will fail with x509 errors unless you configure Prometheus with `insecure_skip_verify: true` (not recommended for production).
